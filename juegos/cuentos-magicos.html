<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cuentacuentos M√°gico</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>
  <script>
    MobileDragDrop.polyfill({ dragImageTranslateOverride: MobileDragDrop.scrollBehaviour.scrollBehaviourDragImageTranslateOverride });
  </script>

  <style>
    body { font-family: 'Fredoka', sans-serif; }

    /* Fondo m√°gico */
    .story-bg {
      background-color: #fff7ed;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23fed7aa' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    /* Contenedor del Libro */
    .book-page {
      background: white;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      border-radius: 24px;
      border: 8px solid #fed7aa; /* Borde color melocot√≥n */
      position: relative;
      overflow: hidden;
    }
    /* L√≠nea decorativa superior */
    .book-page::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 20px;
      background: #ffedd5; z-index: 0;
    }

    /* Texto del cuento */
    .story-text {
      font-size: 1.35rem;
      line-height: 2.5rem;
      color: #4b5563;
      display: inline;
    }

    /* Hueco para soltar */
    .drop-zone {
      display: inline-flex;
      width: 70px; height: 70px;
      vertical-align: middle;
      margin: 0 5px;
      border: 3px dashed #cbd5e1;
      background-color: #f8fafc;
      border-radius: 12px;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    .drop-zone.hovered {
      background-color: #dbeafe;
      border-color: #3b82f6;
      transform: scale(1.1);
    }
    .drop-zone.filled {
      border: none;
      background: transparent;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .drop-zone img {
      width: 100%; height: 100%; object-fit: contain;
    }

    /* Banco de Stickers */
    .sticker-pool {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-top: 4px solid #fdba74;
    }

    .sticker {
      width: 75px; height: 75px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 5px;
      cursor: grab;
      transition: transform 0.2s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .sticker:active { cursor: grabbing; transform: scale(1.1) rotate(3deg); }
    .sticker.dragging { opacity: 0.5; }
    .sticker img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
  </style>
</head>

<body class="story-bg min-h-screen flex flex-col items-center pb-40">

  <div class="w-full max-w-4xl flex justify-between items-center p-4 mt-2">
    <a href="../index.html" class="bg-white hover:bg-orange-50 text-orange-600 px-4 py-2 rounded-xl font-bold shadow-sm transition flex items-center gap-2 text-sm">
      ‚¨Ö Salir
    </a>
    <div class="bg-white px-6 py-2 rounded-xl shadow-sm text-orange-600 font-bold text-xl border border-orange-100">
      Cuento <span id="levelDisplay">1</span>
    </div>
    <div class="w-10"></div>
  </div>

  <div class="w-full max-w-4xl px-4">
    <div class="book-page p-8 md:p-12 min-h-[400px]">
      <h2 id="storyTitle" class="text-3xl font-bold text-orange-700 mb-8 text-center drop-shadow-sm">
        </h2>
      
      <div id="storyContent" class="story-text text-justify">
        </div>
    </div>
  </div>

  <div class="sticker-pool fixed bottom-0 left-0 w-full p-4 z-50 shadow-[0_-10px_30px_rgba(0,0,0,0.1)]">
    <p class="text-center text-orange-400 text-xs font-bold uppercase tracking-widest mb-3">Arrastra las figuras al cuento</p>
    <div id="stickerContainer" class="flex justify-center gap-4 flex-wrap overflow-x-auto pb-2">
      </div>
  </div>

  <script>
    // --- SONIDO Y VOZ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const synth = window.speechSynthesis;

    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;

      if (type === 'pop') {
        osc.frequency.setValueAtTime(400, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
      } else if (type === 'success') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(800, now + 0.2);
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.4);
        osc.start(now); osc.stop(now + 0.4);
      } else if (type === 'error') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
        osc.start(now); osc.stop(now + 0.2);
      }
    }

    function speak(text) {
      if (synth.speaking) synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'es-ES'; utter.rate = 0.9;
      synth.speak(utter);
    }

    // --- DATA DE HISTORIAS ---
    const stories = [
      {
        title: "Caperucita y el Lobo",
        // Usamos tokens especiales {id} para los huecos
        text: "En el {bosque} viv√≠a el {lobo} quien quer√≠a asustar a {caperucita}, ella siempre visitaba a su {abuela} y el se√±or {lenador} los cuidaba siempre del {lobo2}.",
        images: [
          { id: "bosque", name: "Bosque", url: "https://cdn-icons-png.flaticon.com/128/3619/3619374.png" },
          { id: "lobo", name: "Lobo", url: "https://cdn-icons-png.flaticon.com/128/4311/4311997.png" },
          { id: "caperucita", name: "Caperucita", url: "https://cdn-icons-png.flaticon.com/128/1680/1680392.png" },
          { id: "abuela", name: "Abuela", url: "https://cdn-icons-png.flaticon.com/128/2880/2880643.png" },
          { id: "lenador", name: "Le√±ador", url: "https://cdn-icons-png.flaticon.com/128/1960/1960933.png" },
          { id: "lobo2", name: "Lobo", url: "https://cdn-icons-png.flaticon.com/128/4311/4311997.png" } // Duplicado para l√≥gica
        ]
      },
      {
        title: "La Gallina Come Manzanas",
        text: "En la {granja} de la {senora} vive una {gallina} rara que come {manzanas} y deja el {arbol} sin frutos.",
        images: [
          { id: "granja", name: "Granja", url: "https://cdn-icons-png.flaticon.com/128/1813/1813617.png" },
          { id: "senora", name: "Se√±ora", url: "https://cdn-icons-png.flaticon.com/128/2926/2926411.png" },
          { id: "gallina", name: "Gallina", url: "https://cdn-icons-png.flaticon.com/128/3061/3061549.png" },
          { id: "manzanas", name: "Manzanas", url: "https://cdn-icons-png.flaticon.com/512/415/415733.png" },
          { id: "arbol", name: "√Årbol", url: "https://cdn-icons-png.flaticon.com/512/490/490091.png" }
        ]
      },
      {
        title: "La Princesa y el Drag√≥n",
        text: "El {dragon} ten√≠a encerrada a la {princesa}, ella extra√±aba a su {unicornio}. Un d√≠a un {principe} la rescat√≥ y fueron muy felices los dos {pareja}.",
        images: [
          { id: "dragon", name: "Drag√≥n", url: "https://cdn-icons-png.flaticon.com/128/2328/2328500.png" },
          { id: "princesa", name: "Princesa", url: "https://cdn-icons-png.flaticon.com/128/1596/1596580.png" },
          { id: "unicornio", name: "Unicornio", url: "https://cdn-icons-png.flaticon.com/128/2534/2534548.png" },
          { id: "principe", name: "Pr√≠ncipe", url: "https://cdn-icons-png.flaticon.com/128/6970/6970450.png" },
          { id: "pareja", name: "Pareja", url: "https://img.freepik.com/fotos-premium/chica-chico-estan-vestidos-princesa-principe_941435-1071.jpg?semt=ais_hybrid&w=740&q=80" }
        ]
      },
      {
        title: "Los Amiguis",
        text: "El {cerdito} Renato juega con el {caballo} y con el {pato} en el {campo} todo el {sol}.",
        images: [
          { id: "cerdito", name: "Cerdito", url: "https://cdn-icons-png.flaticon.com/128/2931/2931513.png" },
          { id: "caballo", name: "Caballo", url: "https://cdn-icons-png.flaticon.com/128/3819/3819870.png" },
          { id: "pato", name: "Pato", url: "https://cdn-icons-png.flaticon.com/128/2120/2120233.png" },
          { id: "campo", name: "Campo", url: "https://cdn-icons-png.flaticon.com/128/1150/1150353.png" },
          { id: "sol", name: "D√≠a", url: "https://cdn-icons-png.flaticon.com/128/3222/3222808.png" }
        ]
      },
      {
        title: "A Comer Bellotas",
        text: "El {pollito} se despidi√≥ de la {gallina} para ir al {bosque} y se encontr√≥ con el {lobo}. {Juntos} fueron a ver a la {pavo} que prepar√≥ {bellotas} para comer.",
        images: [
          { id: "pollito", name: "Pollito", url: "https://cdn-icons-png.flaticon.com/128/7253/7253330.png" },
          { id: "gallina", name: "Gallina", url: "https://cdn-icons-png.flaticon.com/128/8204/8204496.png" },
          { id: "bosque", name: "Bosque", url: "https://cdn-icons-png.flaticon.com/128/3619/3619374.png" },
          { id: "lobo", name: "Lobo", url: "https://cdn-icons-png.flaticon.com/128/8524/8524285.png" },
          { id: "Juntos", name: "Amigos", url: "https://previews.123rf.com/images/topvectors/topvectors2103/topvectors210300318/165115718-cute-little-fox-playing-with-yellow-chick-vector-illustration.jpg" },
          { id: "pavo", name: "Pavo", url: "https://cdn-icons-png.flaticon.com/512/1998/1998767.png" },
          { id: "bellotas", name: "Bellotas", url: "https://cdn-icons-png.flaticon.com/128/3333/3333586.png" }
        ]
      },
      {
        title: "Los Pajaritos y el Gato",
        text: "En la {casa} viv√≠an {pajaritos} y paseaban por el {dia} soleado, pero hab√≠a un {gato} que quer√≠a quitarles el {arbol}.",
        images: [
          { id: "casa", name: "Casa de P√°jaros", url: "https://cdn-icons-png.flaticon.com/128/8677/8677546.png" },
          { id: "pajaritos", name: "Pajaritos", url: "https://cdn-icons-png.flaticon.com/128/1176/1176704.png" },
          { id: "dia", name: "D√≠a", url: "https://cdn-icons-png.flaticon.com/128/3222/3222808.png" },
          { id: "gato", name: "Gato", url: "https://cdn-icons-png.flaticon.com/128/1864/1864514.png" },
          { id: "arbol", name: "√Årbol", url: "https://cdn-icons-png.flaticon.com/512/490/490091.png" }
        ]
      },
      {
        title: "Ariel",
        text: "Bajo el {mar} viv√≠a {ariel}. Sus amigos el {pez} y el {cangrejo} la acompa√±aban siempre, porque la {ursula} quer√≠a asustarla.",
        images: [
          { id: "mar", name: "Mar", url: "https://img.freepik.com/fotos-premium/ilustracion-dibujos-animados-playa-barcos-oceano_1160834-8922.jpg?semt=ais_hybrid&w=740&q=80" },
          { id: "ariel", name: "Sirena", url: "https://cdn-icons-png.flaticon.com/128/5240/5240496.png" },
          { id: "pez", name: "Pez", url: "https://cdn-icons-png.flaticon.com/128/6789/6789517.png" },
          { id: "cangrejo", name: "Cangrejo", url: "https://cdn-icons-png.flaticon.com/128/1998/1998617.png" },
          { id: "ursula", name: "Bruja del Mar", url: "https://i.etsystatic.com/42415510/r/il/b63181/5729489294/il_570xN.5729489294_rdb8.jpg" }
        ]
      },
      {
        title: "Bella Durmiente",
        text: "En un {castillo} viv√≠an {reyes}, una malvada {bruja} lanz√≥ una maldici√≥n a la {princesa}, ella se pinchar√≠a el dedo con una {rueca}. Ella {durmio} hasta que un {principe} le dio un {beso}.",
        images: [
          { id: "castillo", name: "Castillo", url: "https://cdn-icons-png.flaticon.com/128/7551/7551289.png" },
          { id: "reyes", name: "Reyes", url: "https://img.freepik.com/vector-premium/rey-reina-cute-cartoon_119631-171.jpg" },
          { id: "bruja", name: "Bruja", url: "https://cdn-icons-png.flaticon.com/128/1680/1680401.png" },
          { id: "princesa", name: "Princesa", url: "https://cdn-icons-png.flaticon.com/128/1596/1596580.png" },
          { id: "rueca", name: "M√°quina", url: "https://static.vecteezy.com/system/resources/previews/010/596/971/non_2x/thread-and-needle-logo-vector.jpg" },
          { id: "durmio", name: "Dormida", url: "https://cdn-icons-png.flaticon.com/128/2835/2835780.png" },
          { id: "principe", name: "Pr√≠ncipe", url: "https://cdn-icons-png.flaticon.com/128/6970/6970450.png" },
          { id: "beso", name: "Beso", url: "https://cdn-icons-png.flaticon.com/128/646/646849.png" }
        ]
      },
      {
        title: "La Brujita y la Calabaza",
        text: "La {momia} y el {fantasma} se encontraron una {escoba} y fueron a buscar {caramelos} pero la {bruja} fue con {murcielago} y les regal√≥ una {calabaza}.",
        images: [
          { id: "momia", name: "Momia", url: "https://cdn-icons-png.flaticon.com/128/3384/3384529.png" },
          { id: "fantasma", name: "Fantasma", url: "https://cdn-icons-png.flaticon.com/128/3529/3529285.png" },
          { id: "escoba", name: "Escoba", url: "https://cdn-icons-png.flaticon.com/128/3384/3384252.png" },
          { id: "caramelos", name: "Caramelos", url: "https://cdn-icons-png.flaticon.com/128/1404/1404963.png" },
          { id: "bruja", name: "Bruja", url: "https://cdn-icons-png.flaticon.com/128/1680/1680401.png" },
          { id: "murcielago", name: "Murci√©lago", url: "https://cdn-icons-png.flaticon.com/512/3069/3069167.png" },
          { id: "calabaza", name: "Calabaza", url: "https://cdn-icons-png.flaticon.com/128/685/685844.png" }
        ]
      }
    ];

    let currentLevelIdx = 0;
    let filledSpots = 0;
    let totalSpots = 0;

    function loadLevel() {
      const story = stories[currentLevelIdx];
      document.getElementById('storyTitle').innerText = story.title;
      document.getElementById('levelDisplay').innerText = currentLevelIdx + 1;
      
      const contentDiv = document.getElementById('storyContent');
      const stickersDiv = document.getElementById('stickerContainer');
      
      contentDiv.innerHTML = '';
      stickersDiv.innerHTML = '';
      filledSpots = 0;

      // 1. Procesar el texto para crear huecos
      // Usamos expresiones regulares para encontrar {id}
      const parts = story.text.split(/(\{.*?\})/);
      
      totalSpots = 0;

      parts.forEach(part => {
        if (part.startsWith('{') && part.endsWith('}')) {
          const id = part.slice(1, -1); // quitar llaves
          totalSpots++;
          
          const zone = document.createElement('div');
          zone.className = 'drop-zone';
          zone.dataset.target = id;
          
          // Eventos Drop
          zone.addEventListener('dragover', e => {
            e.preventDefault();
            if (!zone.classList.contains('filled')) zone.classList.add('hovered');
          });
          zone.addEventListener('dragleave', () => zone.classList.remove('hovered'));
          zone.addEventListener('drop', e => handleDrop(e, zone));

          contentDiv.appendChild(zone);
        } else {
          // Es texto normal
          const span = document.createElement('span');
          span.innerText = part;
          contentDiv.appendChild(span);
        }
      });

      // 2. Crear los Stickers (Desordenados)
      const shuffledImages = [...story.images].sort(() => Math.random() - 0.5);
      
      shuffledImages.forEach(imgData => {
        const sticker = document.createElement('div');
        sticker.className = 'sticker';
        sticker.draggable = true;
        sticker.id = `stick-${imgData.id}-${Math.random()}`; // ID √∫nico por si hay duplicados
        sticker.dataset.id = imgData.id;
        sticker.dataset.name = imgData.name;
        
        sticker.innerHTML = `<img src="${imgData.url}">`;

        // Drag Events
        sticker.addEventListener('dragstart', e => {
          playSound('pop');
          e.dataTransfer.setData('id', imgData.id);
          e.dataTransfer.setData('elemId', sticker.id);
          setTimeout(() => sticker.classList.add('dragging'), 0);
        });
        sticker.addEventListener('dragend', () => sticker.classList.remove('dragging'));

        stickersDiv.appendChild(sticker);
      });
    }

    function handleDrop(e, zone) {
      e.preventDefault();
      zone.classList.remove('hovered');
      if (zone.classList.contains('filled')) return;

      const draggedId = e.dataTransfer.getData('id');
      const elemId = e.dataTransfer.getData('elemId');
      const targetId = zone.dataset.target;

      if (draggedId === targetId) {
        // CORRECTO
        playSound('success');
        
        // Mover imagen al hueco
        const originalSticker = document.getElementById(elemId);
        const imgUrl = originalSticker.querySelector('img').src;
        const name = originalSticker.dataset.name;

        zone.classList.add('filled');
        zone.innerHTML = `<img src="${imgUrl}">`;
        speak(name); // Leer la palabra

        originalSticker.remove();
        filledSpots++;

        if (filledSpots === totalSpots) {
          setTimeout(levelComplete, 1000);
        }

      } else {
        // INCORRECTO
        playSound('error');
        zone.style.borderColor = '#ef4444';
        zone.style.backgroundColor = '#fee2e2';
        setTimeout(() => {
          zone.style.borderColor = '#cbd5e1';
          zone.style.backgroundColor = '#f8fafc';
        }, 500);
      }
    }

    function levelComplete() {
      confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
      Swal.fire({
        title: "¬°Cuento Terminado! üìñ‚ú®",
        text: "¬°Qu√© bonita historia!",
        icon: "success",
        confirmButtonText: "Siguiente Cuento ‚û°",
        confirmButtonColor: "#f97316"
      }).then(() => {
        currentLevelIdx++;
        if (currentLevelIdx < stories.length) {
          loadLevel();
        } else {
          Swal.fire({
            title: "¬°Fin! üéâ",
            text: "Has completado todos los cuentos.",
            icon: "success",
            confirmButtonText: "Volver al Men√∫"
          }).then(() => window.location.href = "../index.html");
        }
      });
    }

    // Iniciar
    loadLevel();
  </script>
</body>
</html>