<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cuadro de Doble Entrada</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>
  <script>
    MobileDragDrop.polyfill({
      dragImageTranslateOverride: MobileDragDrop.scrollBehaviour.scrollBehaviourDragImageTranslateOverride
    });
  </script>

  <style>
    body { font-family: 'Fredoka', sans-serif; }

    /* Fondo de papel cuadriculado suave */
    .math-bg {
      background-color: #ffffff;
      background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
      background-size: 20px 20px;
    }

    /* Estructura del Grid Principal */
    .game-grid {
      display: grid;
      /* 1 columna para colores + 5 columnas para formas */
      grid-template-columns: 60px repeat(5, 1fr); 
      gap: 4px;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Celdas del Grid */
    .grid-cell {
      aspect-ratio: 1 / 1;
      border: 2px solid #cbd5e1;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      transition: all 0.3s;
    }

    /* Cabeceras */
    .header-shape {
      border: 2px solid #334155;
      background: #f8fafc;
    }
    .header-color {
      border: none;
      border-radius: 8px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }

    /* Zonas de Drop */
    .drop-zone {
      background-color: #f1f5f9;
      border: 2px dashed #94a3b8;
    }
    .drop-zone.hovered {
      background-color: #dbeafe;
      border-color: #3b82f6;
      transform: scale(1.05);
    }
    .drop-zone.filled {
      border: 2px solid #cbd5e1; /* Borde normal al llenar */
      background-color: white;
      animation: pop 0.3s ease-out;
    }

    /* Piezas Arrastrables */
    .piece {
      width: 60px;
      height: 60px;
      cursor: grab;
      transition: transform 0.2s;
      filter: drop-shadow(0 4px 2px rgba(0,0,0,0.1));
    }
    .piece:active {
      cursor: grabbing;
      transform: scale(1.1);
    }
    .piece.placed {
      cursor: default;
      pointer-events: none;
    }

    @keyframes pop {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>

<body class="math-bg min-h-screen flex flex-col items-center py-8 px-4">

  <div class="w-full max-w-4xl flex justify-between items-center mb-8">
    <a href="../index.html" class="bg-white hover:bg-slate-100 text-slate-600 px-4 py-2 rounded-xl font-bold border border-slate-300 shadow-sm transition flex items-center gap-2 text-sm">
      â¬… Salir
    </a>
    <h1 class="text-3xl font-bold text-slate-700">LÃ³gica: Formas y Colores</h1>
    <button onclick="resetGame()" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-xl font-bold hover:bg-blue-200 transition text-sm">
      ðŸ”„ Reiniciar
    </button>
  </div>

  <div class="bg-white p-4 rounded-2xl shadow-xl border-4 border-slate-200 mb-8 w-full max-w-3xl overflow-x-auto">
    <div id="gameGrid" class="game-grid min-w-[500px]">
      </div>
  </div>

  <div class="w-full max-w-3xl bg-slate-100/80 backdrop-blur rounded-2xl p-6 border-t-4 border-slate-300">
    <p class="text-center text-slate-500 font-bold mb-4 uppercase text-xs tracking-widest">Piezas disponibles</p>
    <div id="piecesPool" class="flex flex-wrap justify-center gap-4 min-h-[80px]">
      </div>
  </div>

  <script>
    // --- SONIDOS ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;

      if (type === 'drop') {
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0.01, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
      } else if (type === 'win') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(300, now);
        osc.frequency.setValueAtTime(500, now + 0.1);
        osc.frequency.setValueAtTime(800, now + 0.3);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0.01, now + 0.5);
        osc.start(now); osc.stop(now + 0.5);
      }
    }

    // --- CONFIGURACIÃ“N ---
    // Colores definidos (Tailwind hex values)
    const colors = [
      { id: 'blue',   hex: '#2563eb', name: 'Azul' },
      { id: 'yellow', hex: '#facc15', name: 'Amarillo' },
      { id: 'red',    hex: '#dc2626', name: 'Rojo' },
      { id: 'green',  hex: '#16a34a', name: 'Verde' }
    ];

    // Formas definidas (Tipo de forma)
    const shapes = ['circle', 'triangle', 'square', 'star', 'heart'];

    let placedCount = 0;
    const totalPieces = colors.length * shapes.length;

    // --- GENERADOR DE SVG ---
    // Esta funciÃ³n dibuja las formas matemÃ¡ticamente
    function getShapeSVG(shape, color, isOutline = false) {
      const fill = isOutline ? 'none' : color;
      const stroke = isOutline ? '#334155' : 'none'; // Gris oscuro para borde
      const strokeWidth = isOutline ? '3' : '0';

      let path = '';
      
      switch(shape) {
        case 'circle':
          return `<svg viewBox="0 0 24 24" class="w-full h-full p-2"><circle cx="12" cy="12" r="10" fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}"/></svg>`;
        case 'square':
          return `<svg viewBox="0 0 24 24" class="w-full h-full p-2"><rect x="3" y="3" width="18" height="18" rx="2" fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}"/></svg>`;
        case 'triangle':
          return `<svg viewBox="0 0 24 24" class="w-full h-full p-2"><polygon points="12,2 22,21 2,21" fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}" stroke-linejoin="round"/></svg>`;
        case 'star': // Estrella de 5 puntas
          return `<svg viewBox="0 0 24 24" class="w-full h-full p-2"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9" fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}" stroke-linejoin="round"/></svg>`;
        case 'heart': // CorazÃ³n (Path complejo)
          const d = "M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z";
          return `<svg viewBox="0 0 24 24" class="w-full h-full p-2"><path d="${d}" fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}"/></svg>`;
      }
      return '';
    }

    // --- INICIAR JUEGO ---
    function initGame() {
      const grid = document.getElementById("gameGrid");
      const pool = document.getElementById("piecesPool");
      grid.innerHTML = '';
      pool.innerHTML = '';
      placedCount = 0;

      // 1. CONSTRUIR GRID
      
      // A) Esquina superior izquierda (vacÃ­a)
      const emptyCorner = document.createElement("div");
      grid.appendChild(emptyCorner);

      // B) Cabeceras de Formas (Fila superior)
      shapes.forEach(shape => {
        const cell = document.createElement("div");
        cell.className = "grid-cell header-shape";
        // Dibujamos la forma solo con borde (outline)
        cell.innerHTML = getShapeSVG(shape, null, true);
        grid.appendChild(cell);
      });

      // C) Filas de Colores
      colors.forEach(color => {
        // Cabecera de Color (Columna izquierda)
        const colorHeader = document.createElement("div");
        colorHeader.className = "grid-cell header-color";
        colorHeader.style.backgroundColor = color.hex;
        grid.appendChild(colorHeader);

        // Celdas vacÃ­as (Drop Zones)
        shapes.forEach(shape => {
          const zone = document.createElement("div");
          zone.className = "grid-cell drop-zone";
          zone.dataset.targetColor = color.id;
          zone.dataset.targetShape = shape;

          // Eventos Drop
          zone.addEventListener("dragover", e => {
            e.preventDefault();
            if(!zone.classList.contains("filled")) zone.classList.add("hovered");
          });
          zone.addEventListener("dragleave", () => zone.classList.remove("hovered"));
          zone.addEventListener("drop", e => handleDrop(e, zone));

          grid.appendChild(zone);
        });
      });

      // 2. CREAR PIEZAS (Mezcladas)
      let allPieces = [];
      colors.forEach(color => {
        shapes.forEach(shape => {
          allPieces.push({ color: color, shape: shape });
        });
      });

      // Barajar
      allPieces.sort(() => Math.random() - 0.5);

      allPieces.forEach((item, index) => {
        const pieceDiv = document.createElement("div");
        pieceDiv.className = "piece";
        pieceDiv.draggable = true;
        pieceDiv.dataset.colorId = item.color.id;
        pieceDiv.dataset.shapeType = item.shape;
        pieceDiv.id = `piece-${index}`;
        
        // Dibujamos la forma rellena con su color
        pieceDiv.innerHTML = getShapeSVG(item.shape, item.color.hex, false);

        // Eventos Drag
        pieceDiv.addEventListener("dragstart", e => {
          e.dataTransfer.setData("colorId", item.color.id);
          e.dataTransfer.setData("shapeType", item.shape);
          e.dataTransfer.setData("elementId", pieceDiv.id);
          setTimeout(() => pieceDiv.style.opacity = '0.5', 0);
        });
        pieceDiv.addEventListener("dragend", () => pieceDiv.style.opacity = '1');

        pool.appendChild(pieceDiv);
      });
    }

    function handleDrop(e, zone) {
      e.preventDefault();
      zone.classList.remove("hovered");
      if(zone.classList.contains("filled")) return;

      const draggedColor = e.dataTransfer.getData("colorId");
      const draggedShape = e.dataTransfer.getData("shapeType");
      const elementId = e.dataTransfer.getData("elementId");

      // Validar coincidencia
      if (draggedColor === zone.dataset.targetColor && draggedShape === zone.dataset.targetShape) {
        // CORRECTO
        playSound('drop');
        zone.classList.add("filled");
        
        // Mover la pieza visualmente a la celda
        // O mejor: regenerar el SVG dentro de la celda para que quede perfecto
        // Buscamos el color hex correspondiente
        const colorObj = colors.find(c => c.id === draggedColor);
        zone.innerHTML = getShapeSVG(draggedShape, colorObj.hex, false);

        // Eliminar del pool
        const originalPiece = document.getElementById(elementId);
        if(originalPiece) originalPiece.remove();

        placedCount++;

        if(placedCount === totalPieces) {
          gameWin();
        }
      } else {
        // ERROR
        // Efecto visual de rechazo
        zone.style.backgroundColor = "#fee2e2"; // Rojo suave
        setTimeout(() => zone.style.backgroundColor = "", 300);
      }
    }

    function gameWin() {
      playSound('win');
      confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
      Swal.fire({
        title: "Â¡LÃ³gica Perfecta! ðŸ§ âœ¨",
        text: "Has completado todo el cuadro de doble entrada.",
        icon: "success",
        confirmButtonText: "Jugar otra vez",
        confirmButtonColor: "#2563eb"
      }).then(() => resetGame());
    }

    function resetGame() {
      initGame();
    }

    initGame();
  </script>
</body>
</html>