<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>La Granja de Sombras</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>
  <script>
    MobileDragDrop.polyfill({ dragImageTranslateOverride: MobileDragDrop.scrollBehaviour.scrollBehaviourDragImageTranslateOverride });
  </script>

  <style>
    body { font-family: 'Fredoka', sans-serif; }

    /* Fondo de campo */
    .farm-bg {
      background-color: #7dd3fc; /* Cielo */
      background-image: linear-gradient(to bottom, #7dd3fc 0%, #bae6fd 40%, #86efac 40%, #4ade80 100%);
    }

    /* EL GRANERO (CSS puro) */
    .barn-roof {
      width: 100%;
      height: 60px;
      background: #7f1d1d; /* Rojo oscuro */
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
      margin-bottom: -1px;
    }
    .barn-body {
      background-color: #dc2626; /* Rojo */
      border: 4px solid #7f1d1d;
      border-top: none;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      position: relative;
    }
    /* Decoraci√≥n de puerta de granero */
    .barn-door-decoration {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      opacity: 0.1;
      background-image: repeating-linear-gradient(45deg, transparent, transparent 20px, #000 20px, #000 22px);
    }

    /* SILUETAS (Destino) */
    .silhouette-box {
      background: white;
      border: 3px solid #fca5a5;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      aspect-ratio: 1/1;
      transition: all 0.3s;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
    }
    .silhouette-box.hovered {
      background: #fef3c7;
      border-color: #f59e0b;
      transform: scale(1.05);
    }
    
    /* EL TRUCO DE LA SOMBRA */
    .shadow-img {
      filter: brightness(0) opacity(0.8); /* Convierte cualquier imagen en silueta negra */
      width: 70%;
      height: 70%;
      object-fit: contain;
      transition: all 0.5s;
    }
    
    .silhouette-box.filled .shadow-img {
      filter: none; /* Quita el filtro negro y muestra el color */
      width: 90%;
      height: 90%;
      animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* ANIMALES ARRASTRABLES */
    .animal-token {
      width: 70px;
      height: 70px;
      background: white;
      border: 3px solid #bfdbfe;
      border-radius: 50%;
      padding: 5px;
      cursor: grab;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .animal-token img {
      width: 100%; height: 100%; object-fit: contain; pointer-events: none;
    }
    .animal-token:active { cursor: grabbing; transform: scale(1.1); }
    .animal-token.dragging { opacity: 0.5; }

    @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
  </style>
</head>

<body class="farm-bg min-h-screen flex flex-col items-center justify-center p-4">

  <div class="absolute top-4 left-4 right-4 flex justify-between items-center z-10">
    <a href="../index.html" class="bg-white hover:bg-slate-100 text-slate-700 px-4 py-2 rounded-xl font-bold shadow-sm transition flex items-center gap-2 text-sm">
      ‚¨Ö Salir
    </a>
    <div class="bg-white/80 px-6 py-2 rounded-full backdrop-blur shadow-sm">
      <h1 class="text-xl font-bold text-red-800">üêÆ La Granja de Sombras</h1>
    </div>
    <div class="w-20"></div>
  </div>

  <div class="flex flex-col items-center justify-center w-full max-w-4xl h-full mt-10 gap-8">
    
    <div class="w-full max-w-2xl relative animate-in fade-in zoom-in duration-500">
      <div class="barn-roof mx-auto w-3/4 md:w-2/3"></div>
      
      <div class="barn-body rounded-b-3xl p-6 md:p-8">
        <div class="barn-door-decoration"></div>
        
        <div id="barnGrid" class="grid grid-cols-3 md:grid-cols-4 gap-3 relative z-10">
          </div>
      </div>
      
      <div class="absolute -bottom-4 -left-6 w-24 h-12 bg-green-600 rounded-full z-0"></div>
      <div class="absolute -bottom-4 -right-6 w-24 h-12 bg-green-600 rounded-full z-0"></div>
    </div>

    <div class="bg-white/60 backdrop-blur-md rounded-3xl p-4 border-t-4 border-green-400 w-full overflow-x-auto">
      <div id="animalPool" class="flex flex-wrap justify-center gap-4 min-w-max md:min-w-0 p-2">
        </div>
    </div>

  </div>

  <script>
    // --- SONIDOS ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const synth = window.speechSynthesis;

    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;

      if (type === 'success') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(800, now + 0.1);
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
      } else if (type === 'pop') {
        osc.frequency.setValueAtTime(300, now); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
      }
    }

    function speak(text) {
      if (synth.speaking) synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'es-ES'; utter.rate = 1.0;
      synth.speak(utter);
    }

    // --- DATOS DE ANIMALES (Im√°genes de Flaticon) ---
    const animals = [
      { id: 'vaca', name: 'Vaca', img: 'https://cdn-icons-png.flaticon.com/512/1998/1998610.png' },
      { id: 'cerdo', name: 'Cerdo', img: 'https://cdn-icons-png.flaticon.com/128/2931/2931513.png' },
      { id: 'carnero', name: 'Oveja', img: 'https://cdn-icons-png.flaticon.com/128/8277/8277647.png' },
      { id: 'gallina', name: 'Gallina', img: 'https://cdn-icons-png.flaticon.com/128/8204/8204496.png' },
      { id: 'pollito', name: 'Pollito', img: 'https://cdn-icons-png.flaticon.com/128/7253/7253330.png' },
      { id: 'caballo', name: 'Caballo', img: 'https://cdn-icons-png.flaticon.com/128/1998/1998679.png' },
      { id: 'pato', name: 'Pato', img: 'https://cdn-icons-png.flaticon.com/128/2120/2120233.png' },
      { id: 'pavo', name: 'Pavo', img: 'https://cdn-icons-png.flaticon.com/128/1998/1998807.png' },
      { id: 'gallo', name: 'Gallo', img: 'https://cdn-icons-png.flaticon.com/128/3200/3200030.png' },
      { id: 'cuy', name: 'Cuy', img: 'https://cdn-icons-png.flaticon.com/128/13507/13507872.png' },
      { id: 'cabra', name: 'Cabra', img: 'https://cdn-icons-png.flaticon.com/128/1998/1998662.png' }
    ];

    let correctCount = 0;

    // --- INICIALIZAR ---
    function initGame() {
      const barnGrid = document.getElementById("barnGrid");
      const animalPool = document.getElementById("animalPool");

      // 1. Crear Siluetas en el Granero
      animals.forEach(animal => {
        const box = document.createElement("div");
        box.className = "silhouette-box";
        box.dataset.target = animal.id;
        
        // Aqu√≠ est√° el TRUCO: ponemos la imagen a color pero con filtro CSS brightness(0)
        // para que parezca una sombra perfecta.
        box.innerHTML = `<img src="${animal.img}" class="shadow-img" id="shadow-${animal.id}">`;

        // Eventos Drop
        box.addEventListener("dragover", e => {
          e.preventDefault();
          if(!box.classList.contains("filled")) box.classList.add("hovered");
        });
        box.addEventListener("dragleave", () => box.classList.remove("hovered"));
        box.addEventListener("drop", e => handleDrop(e, box));

        barnGrid.appendChild(box);
      });

      // 2. Crear Fichas de Animales (Mezcladas)
      const shuffledAnimals = [...animals].sort(() => Math.random() - 0.5);

      shuffledAnimals.forEach(animal => {
        const token = document.createElement("div");
        token.className = "animal-token";
        token.draggable = true;
        token.id = `token-${animal.id}`;
        token.dataset.id = animal.id;
        token.innerHTML = `<img src="${animal.img}">`;

        // Eventos Drag
        token.addEventListener("dragstart", e => {
          playSound('pop');
          e.dataTransfer.setData("id", animal.id);
          e.dataTransfer.setData("tokenId", token.id);
          setTimeout(() => token.classList.add('dragging'), 0);
        });
        token.addEventListener("dragend", () => token.classList.remove('dragging'));

        animalPool.appendChild(token);
      });
    }

    // --- MANEJO DEL DROP ---
    function handleDrop(e, box) {
      e.preventDefault();
      box.classList.remove("hovered");
      if(box.classList.contains("filled")) return;

      const draggedId = e.dataTransfer.getData("id");
      const tokenId = e.dataTransfer.getData("tokenId");
      const targetId = box.dataset.target;

      if (draggedId === targetId) {
        // CORRECTO
        playSound('success');
        box.classList.add("filled");
        
        // Encontrar el nombre del animal para decirlo
        const animalData = animals.find(a => a.id === draggedId);
        speak("¬°" + animalData.name + "!");

        // Eliminar la ficha de abajo
        const token = document.getElementById(tokenId);
        if(token) token.remove();

        // Al a√±adir la clase 'filled', el CSS autom√°ticamente quita el filtro negro
        // y muestra el animal a color dentro de la caja.

        correctCount++;
        if(correctCount === animals.length) {
          setTimeout(victory, 1000);
        }

      } else {
        // INCORRECTO
        speak("Intenta de nuevo");
        box.style.borderColor = "#ef4444";
        box.style.backgroundColor = "#fee2e2";
        setTimeout(() => {
          box.style.borderColor = "#fca5a5";
          box.style.backgroundColor = "white";
        }, 500);
      }
    }

    function victory() {
      confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
      Swal.fire({
        title: "¬°Granja Completa! üêÆüê∑",
        text: "¬°Todos los animales est√°n en su casa!",
        icon: "success",
        confirmButtonText: "Jugar de nuevo",
        confirmButtonColor: "#dc2626"
      }).then(() => window.location.reload());
    }

    initGame();
  </script>
</body>
</html>