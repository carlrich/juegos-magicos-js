<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Completa con Im√°genes</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>
  <script>
    MobileDragDrop.polyfill({ dragImageTranslateOverride: MobileDragDrop.scrollBehaviour.scrollBehaviourDragImageTranslateOverride });
  </script>

  <style>
    body { font-family: 'Fredoka', sans-serif; }

    /* Fondo escolar suave */
    .school-bg {
      background-color: #f0f9ff;
      background-image: radial-gradient(#bae6fd 2px, transparent 2px);
      background-size: 30px 30px;
    }

    /* Fila de la oraci√≥n */
    .sentence-card {
      background: white;
      border-radius: 20px;
      padding: 15px 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      border-left: 8px solid #3b82f6;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap; /* Para que se adapte en m√≥viles */
      margin-bottom: 20px;
      animation: slideIn 0.5s ease-out;
    }

    /* El hueco para soltar */
    .drop-zone {
      width: 70px;
      height: 70px;
      border: 3px dashed #94a3b8;
      border-radius: 12px;
      background-color: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .drop-zone.hovered {
      background-color: #dbeafe;
      border-color: #3b82f6;
      transform: scale(1.1);
    }
    .drop-zone.filled {
      border: 2px solid #22c55e;
      background-color: #fff;
      border-style: solid;
      padding: 5px;
    }
    .drop-zone.filled img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        animation: pop 0.3s;
    }

    /* Im√°genes arrastrables (en el banco) */
    .draggable-img {
      width: 80px;
      height: 80px;
      cursor: grab;
      transition: transform 0.2s;
      filter: drop-shadow(0 4px 3px rgba(0,0,0,0.1));
      background: white;
      padding: 5px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }
    .draggable-img:active {
      cursor: grabbing;
      transform: scale(1.1) rotate(3deg);
    }
    .draggable-img.dragging { opacity: 0.5; }

    /* Texto grande */
    .text-xl-custom {
      font-size: 1.5rem;
      color: #334155;
      font-weight: 600;
    }

    /* Imagen est√°tica (resultado) */
    .result-img {
      width: 60px;
      height: 60px;
      object-fit: contain;
    }

    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
  </style>
</head>

<body class="school-bg min-h-screen flex flex-col items-center p-4 pb-32">

  <div class="w-full max-w-3xl flex justify-between items-center mb-8 mt-4">
    <a href="../index.html" class="bg-white text-slate-600 hover:text-blue-600 px-4 py-2 rounded-xl font-bold shadow-sm transition flex items-center gap-2 text-sm">
      ‚¨Ö Salir
    </a>
    <div class="bg-white px-6 py-2 rounded-xl shadow-sm text-blue-600 font-bold text-xl">
      Nivel <span id="levelDisplay">1</span>
    </div>
    <div class="w-10"></div>
  </div>

  <div id="gameArea" class="w-full max-w-3xl flex flex-col gap-4">
    </div>

  <div class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur border-t-4 border-blue-200 p-4 shadow-[0_-10px_20px_rgba(0,0,0,0.1)] z-50">
    <p class="text-center text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Arrastra la imagen correcta</p>
    <div id="imagePool" class="flex justify-center gap-4 flex-wrap">
      </div>
  </div>

  <script>
    // --- SONIDOS ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;

      if (type === 'pop') {
        osc.frequency.setValueAtTime(400, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.1);
        osc.start(now); osc.stop(now + 0.1);
      } else if (type === 'success') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(800, now + 0.2);
        gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
      } else if (type === 'error') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
        osc.start(now); osc.stop(now + 0.2);
      }
    }

    // --- DATOS DE NIVELES ---
    // Estructura: Pre-Texto + [HUECO] + Post-Texto + [IMAGEN FINAL]
    // 'targetId' debe coincidir con el 'id' de la imagen correcta
    const levels = [
      { // NIVEL 1: Granja
        items: [
          { id: 'vaca', imgUrl: 'https://cdn-icons-png.flaticon.com/512/1998/1998610.png' },
          { id: 'gallina', imgUrl: 'https://cdn-icons-png.flaticon.com/128/9998/9998948.png' },
          { id: 'oveja', imgUrl: 'https://cdn-icons-png.flaticon.com/128/8277/8277647.png' }
        ],
        questions: [
          { pre: "La", targetId: "vaca", post: "nos da", resultImg: "https://cdn-icons-png.flaticon.com/128/6034/6034226.png" }, // Leche
          { pre: "La", targetId: "gallina", post: "pone", resultImg: "https://cdn-icons-png.flaticon.com/128/5508/5508472.png" }, // Huevos
          { pre: "La", targetId: "oveja", post: "tiene", resultImg: "https://cdn-icons-png.flaticon.com/128/2972/2972165.png" } // Lana
        ]
      },
      { // NIVEL 2: Comida de Animales
        items: [
          { id: 'conejo', imgUrl: 'https://cdn-icons-png.flaticon.com/128/2663/2663100.png' },
          { id: 'mono', imgUrl: 'https://cdn-icons-png.flaticon.com/128/616/616591.png' },
          { id: 'raton', imgUrl: 'https://cdn-icons-png.flaticon.com/128/2817/2817912.png' }
        ],
        questions: [
          { pre: "El", targetId: "conejo", post: "come", resultImg: "https://cdn-icons-png.flaticon.com/128/8323/8323889.png" }, // Zanahoria
          { pre: "El", targetId: "mono", post: "come", resultImg: "https://cdn-icons-png.flaticon.com/128/9861/9861871.png" }, // Banana
          { pre: "El", targetId: "raton", post: "come", resultImg: "https://cdn-icons-png.flaticon.com/128/6272/6272451.png" } // Queso
        ]
      },
      { // NIVEL 3: Colores
        items: [
          { id: 'sol', imgUrl: 'https://cdn-icons-png.flaticon.com/512/869/869869.png' },
          { id: 'manzana', imgUrl: 'https://cdn-icons-png.flaticon.com/512/415/415733.png' },
          { id: 'hoja', imgUrl: 'https://cdn-icons-png.flaticon.com/128/3791/3791257.png' }
        ],
        questions: [
          { pre: "El", targetId: "sol", post: "es", resultImg: "https://cdn-icons-png.flaticon.com/128/14026/14026175.png" }, // Amarillo
          { pre: "La", targetId: "manzana", post: "es", resultImg: "https://cdn-icons-png.flaticon.com/128/594/594739.png" }, // Roja
          { pre: "La", targetId: "hoja", post: "es", resultImg: "https://cdn-icons-png.flaticon.com/128/14035/14035769.png" } // Verde
        ]
      },
      { // NIVEL 4: H√°bitat
        items: [
          { id: 'pez', imgUrl: 'https://cdn-icons-png.flaticon.com/128/2371/2371907.png' },
          { id: 'pajaro', imgUrl: 'https://cdn-icons-png.flaticon.com/128/3069/3069186.png' },
          { id: 'topo', imgUrl: 'https://cdn-icons-png.flaticon.com/128/1459/1459520.png' }
        ],
        questions: [
          { pre: "El", targetId: "pez", post: "vive en el", resultImg: "https://cdn-icons-png.flaticon.com/128/3075/3075404.png" }, // Agua
          { pre: "El", targetId: "pajaro", post: "vuela en el", resultImg: "https://cdn-icons-png.flaticon.com/128/2272/2272202.png" }, // Cielo
          { pre: "El", targetId: "topo", post: "vive en la", resultImg: "https://cdn-icons-png.flaticon.com/128/3382/3382647.png" } // Tierra
        ]
      },
      { // NIVEL 5: Profesiones (Simple)
        items: [
          { id: 'doctor', imgUrl: 'https://cdn-icons-png.flaticon.com/128/2785/2785482.png' },
          { id: 'bombero', imgUrl: 'https://cdn-icons-png.flaticon.com/128/4594/4594683.png' },
          { id: 'policia', imgUrl: 'https://cdn-icons-png.flaticon.com/512/2503/2503500.png' }
        ],
        questions: [
          { pre: "El", targetId: "doctor", post: "trabaja en el", resultImg: "https://cdn-icons-png.flaticon.com/128/2749/2749678.png" }, // Hospital
          { pre: "El", targetId: "bombero", post: "usa el", resultImg: "https://cdn-icons-png.flaticon.com/128/2820/2820576.png" }, // Cami√≥n
          { pre: "El", targetId: "policia", post: "conduce la", resultImg: "https://cdn-icons-png.flaticon.com/128/1890/1890512.png" } // Patrulla
        ]
      }
    ];

    let currentLevelIdx = 0;
    let correctInLevel = 0;

    // --- INICIALIZAR ---
    function loadLevel() {
      const gameArea = document.getElementById("gameArea");
      const imagePool = document.getElementById("imagePool");
      document.getElementById("levelDisplay").innerText = currentLevelIdx + 1;
      
      gameArea.innerHTML = "";
      imagePool.innerHTML = "";
      correctInLevel = 0;

      const levelData = levels[currentLevelIdx];

      // 1. Generar las 3 oraciones
      levelData.questions.forEach((q, index) => {
        const row = document.createElement("div");
        row.className = "sentence-card";
        row.innerHTML = `
          <span class="text-xl-custom">${q.pre}</span>
          <div class="drop-zone" data-target="${q.targetId}"></div>
          <span class="text-xl-custom">${q.post}</span>
          <img src="${q.resultImg}" class="result-img" alt="resultado">
        `;

        // Configurar Drop
        const zone = row.querySelector('.drop-zone');
        zone.addEventListener("dragover", e => {
          e.preventDefault();
          if (!zone.classList.contains('filled')) zone.classList.add('hovered');
        });
        zone.addEventListener("dragleave", () => zone.classList.remove('hovered'));
        zone.addEventListener("drop", e => handleDrop(e, zone));

        gameArea.appendChild(row);
      });

      // 2. Generar las im√°genes arrastrables (Pool)
      // Mezclamos las im√°genes del nivel
      const shuffledItems = [...levelData.items].sort(() => Math.random() - 0.5);
      
      shuffledItems.forEach(item => {
        const img = document.createElement("img");
        img.src = item.imgUrl;
        img.className = "draggable-img";
        img.draggable = true;
        img.dataset.id = item.id;
        img.id = `drag-${item.id}`; // ID √∫nico para manipularlo

        // Eventos Drag
        img.addEventListener("dragstart", e => {
          playSound('pop');
          e.dataTransfer.setData("imgId", item.id);
          e.dataTransfer.setData("imgSrc", item.imgUrl);
          e.dataTransfer.setData("elementId", img.id);
          setTimeout(() => img.classList.add("dragging"), 0);
        });
        img.addEventListener("dragend", () => img.classList.remove("dragging"));

        imagePool.appendChild(img);
      });
    }

    // --- MANEJO DEL DROP ---
    function handleDrop(e, zone) {
      e.preventDefault();
      zone.classList.remove('hovered');
      
      if(zone.classList.contains('filled')) return;

      const draggedId = e.dataTransfer.getData("imgId");
      const draggedSrc = e.dataTransfer.getData("imgSrc");
      const elementId = e.dataTransfer.getData("elementId");
      const targetId = zone.dataset.target;

      if(draggedId === targetId) {
        // CORRECTO
        playSound('success');
        zone.classList.add('filled');
        zone.innerHTML = `<img src="${draggedSrc}">`;
        
        // Eliminar la imagen del pool
        const originalImg = document.getElementById(elementId);
        if(originalImg) originalImg.remove();

        correctInLevel++;
        if(correctInLevel === 3) {
          setTimeout(levelComplete, 500);
        }

      } else {
        // INCORRECTO
        playSound('error');
        zone.style.backgroundColor = "#fee2e2"; // Rojo
        zone.style.borderColor = "#ef4444";
        
        Swal.fire({
          toast: true, position: 'top', icon: 'warning',
          title: 'Esa no parece la correcta ü§î', showConfirmButton: false, timer: 1500
        });

        setTimeout(() => {
          zone.style.backgroundColor = "#f8fafc";
          zone.style.borderColor = "#94a3b8";
        }, 500);
      }
    }

    function levelComplete() {
      confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });
      
      Swal.fire({
        title: "¬°Historia Completa! üìñ",
        text: "¬°Muy bien hecho!",
        icon: "success",
        confirmButtonText: "Siguiente Nivel",
        confirmButtonColor: "#3b82f6"
      }).then(() => {
        currentLevelIdx++;
        if(currentLevelIdx < levels.length) {
          loadLevel();
        } else {
          Swal.fire({
            title: "¬°Fant√°stico! üåü",
            text: "Has completado todos los cuentos.",
            icon: "success",
            confirmButtonText: "Volver al Men√∫"
          }).then(() => window.location.href = "../index.html");
        }
      });
    }

    // Iniciar
    loadLevel();
  </script>
</body>
</html>